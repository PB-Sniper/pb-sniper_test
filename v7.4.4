(function(){
    if(document.getElementById('pbs-main-panel')) return;

    var serverOffset = 0;
    var lastPlannedFireTime = null;
    var countdownTimer = null;
    var suspendedRetryEnabled = true;
    var originalFetch = window.fetch;
    var isIntercepting = false;
    var targetPid = null;

    // --- 1. LOG PANEL (Âª£Êù±Ë©±/È¶ôÊ∏ØÁî®Ë™û) ---
    var logPanel = document.createElement('div');
    logPanel.id = 'pbs-log-panel';
    logPanel.style.cssText = 'position:fixed;bottom:20px;left:20px;width:380px;height:260px;overflow-y:auto;background:rgba(0,0,0,0.9);color:#fff;font-family:Consolas,monospace;font-size:12px;padding:10px;border:1px solid #555;border-radius:6px;z-index:999999;white-space:pre-wrap;box-shadow:0 4px 10px rgba(0,0,0,0.5);display:none;';
    document.body.appendChild(logPanel);

    function log(type, msg) {
        logPanel.style.display = 'block';
        var line = document.createElement('div');
        var color = '#fff';
        if(type === 'SUCCESS') color = '#00ff88';
        if(type === 'INFO')    color = '#00d0ff';
        if(type === 'WARNING') color = '#ffcc00';
        if(type === 'ERROR')   color = '#ff4444';
        if(type === 'GUARD')   color = '#00bfff';
        if(type === 'HOOK')    color = '#ff00ff';

        var nowForLog = new Date(Date.now() + serverOffset);
        var time = nowForLog.toLocaleTimeString('en-GB') + '.' + String(nowForLog.getMilliseconds()).padStart(3,'0');
        line.style.color = color;
        line.style.borderBottom = '1px solid #333';
        line.style.padding = '2px 0';
        line.innerText = '[' + time + '] [' + type + '] ' + msg;
        logPanel.appendChild(line);
        logPanel.scrollTop = logPanel.scrollHeight;
    }

    // --- 2. AUTO-DETECT PRODUCT ID ---
    try {
        var scripts = [].slice.call(document.querySelectorAll('script'));
        for (var i = 0; i < scripts.length; i++) {
            if (scripts[i].textContent.includes('PRELOAD_DATA =')) {
                var jsonMatch = scripts[i].textContent.match(/PRELOAD_DATA\s*=\s*({.*?})\s*$/m);
                if (jsonMatch) {
                    var data = JSON.parse(jsonMatch[1]);
                    if(data.product && data.product.areaItemNos) {
                        targetPid = data.product.areaItemNos[0];
                    }
                }
                break;
            }
        }
    } catch(e) { console.error(e); }

    // --- 3. MAIN UI PANEL (Ëã±Êñá) ---
    var panel = document.createElement('div');
    panel.id = 'pbs-main-panel';
    panel.style.cssText = 'position:fixed;bottom:20px;right:20px;width:320px;background:rgba(20,20,20,0.95);color:#fff;z-index:999999;padding:15px;border-radius:8px;font-size:13px;border:1px solid #444;box-shadow:0 4px 15px rgba(0,0,0,0.5);font-family:sans-serif;';

    panel.innerHTML = '\
        <h3 style="color:#fc0;margin:0 0 10px;border-bottom:1px solid #555;padding-bottom:5px;font-size:16px;font-weight:bold;display:flex;justify-content:space-between;">\
            <span>P-Bandai Sniper V7.4.4 <span style="font-size:10px;color:#0f0">Auto</span></span>\
            <span id="pbs-close-btn" style="cursor:pointer;color:#999;font-weight:bold;padding:0 5px;">‚úï</span>\
        </h3>\
        <div style="margin-bottom:8px">\
            <label style="display:block;color:#ccc;font-size:11px">‚è∞ Time</label>\
            <input id="pbs-time" value="16:00:00" style="width:100%;padding:5px;background:#333;color:#fff;border:1px solid #555;border-radius:4px;box-sizing:border-box;">\
        </div>\
        <div id="pbs-countdown" style="margin-bottom:4px;text-align:center;font-size:16px;color:#0fd;">--.-- s</div>\
        <div style="display:flex;gap:10px;margin-bottom:8px">\
            <div style="flex:1">\
                <label style="display:block;color:#ccc;font-size:11px">üî¢ Qty</label>\
                <input id="pbs-qty" type="number" value="1" style="width:100%;padding:5px;background:#333;color:#fff;border:1px solid #555;border-radius:4px;box-sizing:border-box;">\
            </div>\
            <div style="flex:1">\
                <label style="display:block;color:#ccc;font-size:11px">üï∞Ô∏è Offset</label>\
                <input id="pbs-offset" type="number" value="0" placeholder="+/-" style="width:100%;padding:5px;background:#333;color:#fff;border:1px solid #555;border-radius:4px;box-sizing:border-box;">\
            </div>\
        </div>\
        <!-- AUTO FETCH SECTION -->\
        <div style="margin-bottom:10px;border:1px dashed #666;padding:5px;border-radius:4px;background:#2a2a2a">\
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">\
                <label style="color:#ff00ff;font-weight:bold;font-size:11px">üé£ Auto Fetch</label>\
                <div>\
                    <button id="pbs-copy-btn" style="padding:2px 6px;font-size:10px;cursor:pointer;background:#007bff;color:#fff;border:none;border-radius:3px;margin-right:4px;">üìã Copy</button>\
                    <button id="pbs-hook-btn" style="padding:2px 8px;font-size:10px;cursor:pointer;background:#444;color:#fff;border:1px solid #666;border-radius:3px;">Start Hook</button>\
                </div>\
            </div>\
            <textarea id="pbs-fetch" rows="2" style="width:100%;padding:5px;background:#333;color:#aaa;border:1px solid #555;border-radius:4px;font-size:10px;resize:vertical;box-sizing:border-box;" placeholder="Press [Start Hook], then click [Order] on page..."></textarea>\
        </div>\
        <div style="margin-bottom:6px;display:flex;align-items:center;gap:6px;font-size:11px;color:#ccc;">\
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">\
                <input id="pbs-sus-toggle" type="checkbox" checked style="margin:0;">\
                <span>Suspended Retry</span>\
            </label>\
        </div>\
        <button id="pbs-btn" style="width:100%;padding:10px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:14px;text-align:center;">üöÄ Start</button>\
        <div id="pbs-status" style="margin-top:5px;text-align:center;color:#aaa;font-size:11px">Ready.</div>\
        <div style="margin-top:3px;text-align:right;font-size:10px;color:#666;">v7.4.4 ¬∑ by Industrial Revolution + Doro Army</div>\
    ';
    document.body.appendChild(panel);

    // --- VARIABLES ---
    var timeInput   = document.getElementById('pbs-time');
    var qtyInput    = document.getElementById('pbs-qty');
    var offsetInput = document.getElementById('pbs-offset');
    var fetchInput  = document.getElementById('pbs-fetch');
    var btn         = document.getElementById('pbs-btn');
    var status      = document.getElementById('pbs-status');
    var cdLabel     = document.getElementById('pbs-countdown');
    var hookBtn     = document.getElementById('pbs-hook-btn');
    var copyBtn     = document.getElementById('pbs-copy-btn');
    var susToggle   = document.getElementById('pbs-sus-toggle');
    var closeBtn    = document.getElementById('pbs-close-btn');

    // --- INITIAL STATUS ---
    if(targetPid) {
        status.innerHTML = 'Locked: ' + targetPid + ' <span style="color:#00bfff">üõ°Ô∏èGuardian ON</span>';
        status.style.color = '#0f0';
        log('SUCCESS', 'Ëá™ÂãïÈéñÂÆöÂïÜÂìÅ ID: ' + targetPid);
    } else {
        log('WARNING', 'Êú™ÊâæÂà∞ÂïÜÂìÅ IDÔºåË´ãÁ¢∫Ë™çÂú®ÂïÜÂìÅË©≥ÊÉÖÈ†Å');
    }

    // --- CLOSE & CLEANUP ---
    if(closeBtn) {
        closeBtn.onclick = function() {
            if(panel) panel.remove();
            if(logPanel) logPanel.style.display = 'none';
            if(guardTimer) clearInterval(guardTimer);
            if(countdownTimer) clearInterval(countdownTimer);
            window.fetch = originalFetch;
        };
    }

    // --- COPY BUTTON ---
    if(copyBtn) {
        copyBtn.onclick = function() {
            if(!fetchInput.value) return;
            fetchInput.select();
            if(navigator.clipboard) {
                navigator.clipboard.writeText(fetchInput.value);
            } else {
                document.execCommand('copy');
            }
            var originalText = copyBtn.innerText;
            copyBtn.innerText = 'Copied!';
            copyBtn.style.background = '#28a745';
            setTimeout(function(){
                copyBtn.innerText = originalText;
                copyBtn.style.background = '#007bff';
            }, 1500);
        };
    }

    // --- GUARDIAN ---
    log('GUARD', 'Session Guardian V3.0 Â∑≤ÂïüÂãï (ÈÄ£Á∑öÁ∂≠ÊåÅ)');
    var guardTimer = setInterval(function() {
        originalFetch(window.location.href, { method: 'HEAD' })
            .then(function(r) {
                if(r.ok) log('GUARD', 'Session Á∫åÊúüÊàêÂäü (Active)');
                else     log('WARNING', 'ÈÄ£Á∑öÁï∞Â∏∏ Status: ' + r.status);
            })
            .catch(function(e) { log('ERROR', 'ÈÄ£Á∑öÁ∂≤Áµ°ÈåØË™§: ' + e); });
    }, 240000);

    // --- FETCH INTERCEPTOR ---
    hookBtn.onclick = function() {
        if(isIntercepting) {
            window.fetch = originalFetch;
            isIntercepting = false;
            hookBtn.innerText = 'Start Hook';
            hookBtn.style.background = '#444';
            hookBtn.style.color = '#fff';
            log('INFO', 'Áõ£ËÅΩÂ∑≤ÂÅúÊ≠¢');
            return;
        }

        isIntercepting = true;
        hookBtn.innerText = 'Listening...';
        hookBtn.style.background = '#ff00ff';
        hookBtn.style.color = '#fff';
        fetchInput.value = '';
        fetchInput.placeholder = 'Waiting for user action (Click Order now)...';
        log('HOOK', 'Fetch Áõ£ËÅΩ‰∏≠... Ë´ãËß∏Áôº‰∏ÄÊ¨°Ë≥ºË≤∑');

        window.fetch = function(input, init) {
            var urlStr = (typeof input === 'string') ? input : (input.url || '');
            if (init && init.method === 'POST' && (urlStr.includes('cart') || urlStr.includes('add') || urlStr.includes('entry'))) {
                log('HOOK', 'ÊçïÊçâÂà∞Áñë‰ººË´ãÊ±Ç: ' + urlStr);
                var capturedConfig = JSON.parse(JSON.stringify(init));
                
                // AUTO ID SWAP
                if (targetPid && capturedConfig.body) {
                    try {
                        var bodyObj = JSON.parse(capturedConfig.body);
                        var modified = false;
                        function deepReplace(obj) {
                            for (var key in obj) {
                                if (key === 'areaItemNo' || key === 'item_code') {
                                    if(obj[key] !== targetPid) {
                                        log('HOOK', 'üîÑ ÊõøÊèõ ID: ' + obj[key] + ' -> ' + targetPid);
                                        obj[key] = targetPid;
                                        modified = true;
                                    }
                                } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                                    deepReplace(obj[key]);
                                }
                            }
                        }
                        if(Array.isArray(bodyObj)) bodyObj.forEach(item => deepReplace(item));
                        else deepReplace(bodyObj);
                        if(modified) capturedConfig.body = JSON.stringify(bodyObj);
                    } catch(e) {}
                }

                var generatedCode = "fetch('" + urlStr + "', " + JSON.stringify(capturedConfig, null, 2) + ")";
                fetchInput.value = generatedCode;
                fetchInput.style.border = '2px solid #0f0';
                hookBtn.innerText = 'Hooked!';
                hookBtn.style.background = '#28a745';
                window.fetch = originalFetch;
                isIntercepting = false;
                log('SUCCESS', 'Fetch ‰ª£Á¢ºÂ∑≤ÁîüÊàê (Â∑≤Ëá™ÂãïÊõøÊèõ ID)');
                return originalFetch(input, init);
            }
            return originalFetch(input, init);
        };
    };

    // --- SYNC BUTTON ---
    (function(){
        if (!timeInput) return;
        var syncBtn = document.createElement('button');
        syncBtn.id = 'pbs-sync';
        syncBtn.textContent = 'Sync';
        syncBtn.style.marginTop = '4px';
        syncBtn.style.padding = '4px 6px';
        syncBtn.style.fontSize = '11px';
        syncBtn.style.background = '#007bff';
        syncBtn.style.color = '#fff';
        syncBtn.style.border = 'none';
        syncBtn.style.borderRadius = '4px';
        syncBtn.style.cursor = 'pointer';
        timeInput.parentNode.appendChild(syncBtn);

        syncBtn.onclick = function () {
            log('INFO', 'ÈñãÂßãÂ∞çÈå∂...');
            var t0 = Date.now();
            originalFetch(window.location.href, { method: 'HEAD', cache: 'no-store' })
                .then(function (r) {
                    var t1 = Date.now();
                    var dateHeader = r.headers.get('date');
                    if (!dateHeader) { serverOffset = 0; return; }
                    var serverTime = new Date(dateHeader).getTime();
                    var latency = (t1 - t0) / 2;
                    serverOffset = (serverTime + latency) - t1;
                    log('SUCCESS', 'Â∞çÈå∂ÂÆåÊàê Offset: ' + serverOffset + 'ms');
                })
                .catch(function (e) { log('ERROR', 'Â∞çÈå∂Â§±Êïó: ' + e); });
        };
    })();

    // --- COUNTDOWN ---
    function startCountdown(targetTimeMs) {
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = setInterval(function(){
            var now = Date.now() + serverOffset;
            var diff = targetTimeMs - now;
            if (diff <= 0) {
                cdLabel.textContent = '0.00 s';
                clearInterval(countdownTimer);
                countdownTimer = null;
                return;
            }
            cdLabel.textContent = (diff/1000).toFixed(2) + ' s';
        }, 100);
    }

    // --- FIRE LOGIC ---
    function fireWithRetry(url, config, max5xxRetries, attempt5xx, suspendedRetriesLeft) {
        attempt5xx = attempt5xx || 1;
        if (suspendedRetriesLeft == null) suspendedRetriesLeft = 3;
        var sendTime = Date.now() + serverOffset;
        
        log('INFO', 'ÁôºÈÄÅË´ãÊ±Ç Attempt ' + attempt5xx);

        return originalFetch(url, config).then(function(r){
            var latency = (Date.now() + serverOffset) - sendTime;
            log('INFO', 'Latency: ' + latency + 'ms | Status: ' + r.status);

            return r.text().then(function(txt){
                var parsed = null;
                try { parsed = JSON.parse(txt); } catch(_) {}

                // 5xx Retry
                if(r.status >= 500 && !r.ok && attempt5xx < max5xxRetries){
                    log('WARNING', '‰º∫ÊúçÂô® 5xx ÈåØË™§ÔºåÊ∫ñÂÇôÈáçË©¶');
                    return new Promise(function(res){ setTimeout(res, 300); })
                        .then(function(){ return fireWithRetry(url, config, max5xxRetries, attempt5xx+1, suspendedRetriesLeft); });
                }

                // Suspended Retry
                if(suspendedRetryEnabled && r.status === 400 && parsed && parsed.error && parsed.error.includes('SuspendedItem') && suspendedRetriesLeft > 0){
                    log('WARNING', 'ÂïÜÂìÅ SuspendedÔºåÈáçË©¶ÁôºÈÄÅ‰∏≠ (Ââ©È§ò ' + (suspendedRetriesLeft-1) + ' Ê¨°)');
                    return new Promise(function(res){ setTimeout(res, 350); })
                        .then(function(){ return fireWithRetry(url, config, max5xxRetries, attempt5xx, suspendedRetriesLeft-1); });
                }
                
                // Result Analysis
                if(parsed && parsed.totalCartCount){
                    var requestedQty = parseInt(qtyInput.value) || 1;
                    log('SUCCESS', 'üéâ ÊàêÂäüÂä†ÂÖ•Ë≥ºÁâ©Ëªä (Êï∏Èáè: ' + requestedQty + ') | Ë≥ºÁâ©ËªäÁ∏ΩÊï∏: ' + parsed.totalCartCount);
                } else if (parsed && (parsed.error || parsed.additional)) {
                     var err = parsed.error || (parsed.additional && parsed.additional.productOutOfStock ? 'Sold Out' : 'Unknown Error');
                     log('WARNING', 'ÁµêÊûú: ' + err);
                } else if (!parsed && r.ok) {
                    log('SUCCESS', 'Ë´ãÊ±ÇÁôºÈÄÅÊàêÂäü (ÁÑ° JSON ÂõûÊáâ)');
                }
                
                return txt;
            });
        });
    }

    // --- START BUTTON ---
    btn.onclick = function() {
        var timeStr   = timeInput.value;
        var qty       = parseInt(qtyInput.value) || 1;
        var offset    = parseInt(offsetInput.value) || 0;
        var fetchCode = fetchInput.value;

        if (!fetchCode) { log('ERROR', 'ÁÑ°Ê≥ïÂïüÂãï: Áº∫Â∞ë Fetch ‰ª£Á¢º'); return; }

        var match = fetchCode.match(/fetch\\((["'])(.*?)\1,\s*({[\s\S]*})\\)/);
        if (!match) { log('ERROR', 'Fetch Ê†ºÂºèÈåØË™§'); return; }

        var url = match[2];
        var configStr = match[3];
        var config = new Function('return ' + configStr)();

        if(targetPid) {
             try {
                var bodyObj = JSON.parse(config.body);
                if(Array.isArray(bodyObj) && bodyObj[0]) bodyObj[0].areaItemNo = targetPid;
                config.body = JSON.stringify(bodyObj);
             } catch(e){}
        }
        try {
            var bodyObj = JSON.parse(config.body);
            if(Array.isArray(bodyObj) && bodyObj[0]) bodyObj[0].qty = qty;
            config.body = JSON.stringify(bodyObj);
        } catch(e){}

        var now = new Date(Date.now() + serverOffset);
        var target = new Date(now);
        var t = timeStr.split(':');
        target.setHours(t[0], t[1], t[2], 0);
        var delay = target.getTime() - now.getTime() + offset;
        lastPlannedFireTime = target.getTime() + offset;

        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.innerText = '‚è≥ Counting down...';
        
        if(delay < 0) {
            log('WARNING', 'ÊôÇÈñìÂ∑≤ÈÅéÔºåÁ´ãÂç≥ÁôºÂ∞Ñ');
            delay = 0;
        } else {
             log('INFO', 'ÂÄíÊï∏ÈñãÂßãÔºåÂ∞áÊñº ' + (delay/1000).toFixed(3) + ' ÁßíÂæåÁôºÈÄÅ');
        }
        
        startCountdown(lastPlannedFireTime);

        setTimeout(function() {
            fireWithRetry(url, config, 5).then(function(txt){
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.innerText = 'üöÄ Start';
            });
        }, delay);
    };
})();
