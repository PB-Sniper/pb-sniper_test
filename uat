(function(){
    if(document.getElementById('pbs-main-panel')) return;

    var serverOffset = 0;
    var lastPlannedFireTime = null;
    var countdownTimer = null;
    var suspendedRetryEnabled = true;

    // --- 1. LOG é¢æ¿ ---
    var logPanel = document.createElement('div');
    logPanel.id = 'pbs-log-panel';
    logPanel.style.cssText = 'position:fixed;bottom:20px;left:20px;width:380px;height:260px;overflow-y:auto;background:rgba(0,0,0,0.9);color:#fff;font-family:Consolas,monospace;font-size:12px;padding:10px;border:1px solid #555;border-radius:6px;z-index:999999;white-space:pre-wrap;box-shadow:0 4px 10px rgba(0,0,0,0.5);display:none;';
    document.body.appendChild(logPanel);

    function log(type, msg) {
        logPanel.style.display = 'block';
        var line = document.createElement('div');
        var color = '#fff';
        if(type === 'SUCCESS') color = '#00ff88';
        if(type === 'INFO')    color = '#00d0ff';
        if(type === 'WARNING') color = '#ffcc00';
        if(type === 'ERROR')   color = '#ff4444';
        if(type === 'GUARD')   color = '#00bfff';

        var nowForLog = new Date(Date.now() + serverOffset);
        var time = nowForLog.toLocaleTimeString('en-GB') + '.' + String(nowForLog.getMilliseconds()).padStart(3,'0');
        line.style.color = color;
        line.style.borderBottom = '1px solid #333';
        line.style.padding = '2px 0';
        line.innerText = '[' + time + '] [' + type + '] ' + msg;
        logPanel.appendChild(line);
        logPanel.scrollTop = logPanel.scrollHeight;
    }

    // --- 2. Guardian ---
    log('GUARD', 'Session Guardian V3.0 å·²å•Ÿå‹• (æ¯4åˆ†é˜ä¿æ´»)');
    var guardTimer = setInterval(function() {
        fetch(window.location.href, { method: 'HEAD' })
            .then(function(r) {
                if(r.ok) log('GUARD', 'ä¿æ´»æˆåŠŸ (Session Active)');
                else     log('WARNING', 'ä¿æ´»ç•°å¸¸ Status: ' + r.status);
            })
            .catch(function(e) { log('ERROR', 'ä¿æ´»ç¶²çµ¡éŒ¯èª¤: ' + e); });
    }, 240000);

    // --- 3. æ§åˆ¶é¢æ¿ ---
    var panel = document.createElement('div');
    panel.id = 'pbs-main-panel';
    panel.style.cssText = 'position:fixed;bottom:20px;right:20px;width:320px;background:rgba(20,20,20,0.95);color:#fff;z-index:999999;padding:15px;border-radius:8px;font-size:13px;border:1px solid #444;box-shadow:0 4px 15px rgba(0,0,0,0.5);font-family:sans-serif;';

    panel.innerHTML = '\
        <h3 style="color:#fc0;margin:0 0 10px;border-bottom:1px solid #555;padding-bottom:5px;font-size:16px;font-weight:bold;display:flex;justify-content:space-between;">\
            <span>P-Bandai Sniper V7.3.3</span>\
            <span id="pbs-close-btn" style="cursor:pointer;color:#999;font-weight:bold;padding:0 5px;">âœ•</span>\
        </h3>\
        <div style="margin-bottom:8px">\
            <label style="display:block;color:#ccc;font-size:11px">â° Time (HH:MM:SS)</label>\
            <input id="pbs-time" value="16:00:00" style="width:100%;padding:5px;background:#333;color:#fff;border:1px solid #555;border-radius:4px;box-sizing:border-box;">\
        </div>\
        <div id="pbs-countdown" style="margin-bottom:4px;text-align:center;font-size:16px;color:#0fd;">--.-- s</div>\
        <div style="display:flex;gap:10px;margin-bottom:8px">\
            <div style="flex:1">\
                <label style="display:block;color:#ccc;font-size:11px">ğŸ”¢ Qty</label>\
                <input id="pbs-qty" type="number" value="1" style="width:100%;padding:5px;background:#333;color:#fff;border:1px solid #555;border-radius:4px;box-sizing:border-box;">\
            </div>\
            <div style="flex:1">\
                <label style="display:block;color:#ccc;font-size:11px">ğŸ•°ï¸ Offset (ms)</label>\
                <input id="pbs-offset" type="number" value="0" placeholder="+/-" style="width:100%;padding:5px;background:#333;color:#fff;border:1px solid #555;border-radius:4px;box-sizing:border-box;">\
            </div>\
        </div>\
        <div style="margin-bottom:6px;display:flex;align-items:center;gap:6px;font-size:11px;color:#ccc;">\
            <label style="display:flex;align-items:center;gap:4px;cursor:pointer;">\
                <input id="pbs-sus-toggle" type="checkbox" checked style="margin:0;">\
                <span>Suspended Retry</span>\
            </label>\
        </div>\
        <div style="margin-bottom:10px">\
            <label style="display:block;color:#ccc;font-size:11px">ğŸ“‹ Paste Fetch</label>\
            <textarea id="pbs-fetch" rows="3" style="width:100%;padding:5px;background:#333;color:#aaa;border:1px solid #555;border-radius:4px;font-size:11px;resize:vertical;box-sizing:border-box;" placeholder="fetch(...)"></textarea>\
        </div>\
        <button id="pbs-btn" style="width:100%;padding:10px;background:#28a745;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:bold;font-size:14px;text-align:center;">ğŸš€ Start</button>\
        <div id="pbs-status" style="margin-top:5px;text-align:center;color:#aaa;font-size:11px">Ready. <span style="color:#00bfff">ğŸ›¡ï¸Guardian ON</span></div>\
        <div style="margin-top:3px;text-align:right;font-size:10px;color:#666;">v7.3.3 Â· by Industrial Revolution + Doro Army</div>\
    ';
    document.body.appendChild(panel);

    var closeBtn = document.getElementById('pbs-close-btn');
    if(closeBtn) {
        closeBtn.onclick = function() {
            if(panel) panel.remove();
            if(logPanel) logPanel.style.display = 'none';
            if(guardTimer) clearInterval(guardTimer);
            if(countdownTimer) clearInterval(countdownTimer);
        };
    }

    var timeInput   = document.getElementById('pbs-time');
    var qtyInput    = document.getElementById('pbs-qty');
    var offsetInput = document.getElementById('pbs-offset');
    var fetchInput  = document.getElementById('pbs-fetch');
    var btn         = document.getElementById('pbs-btn');
    var status      = document.getElementById('pbs-status');
    var cdLabel     = document.getElementById('pbs-countdown');
    var susToggle   = document.getElementById('pbs-sus-toggle');

    if (susToggle) {
        susToggle.onchange = function () {
            suspendedRetryEnabled = !!susToggle.checked;
            log('INFO', 'Suspended Retry å·²' + (suspendedRetryEnabled ? 'å•Ÿç”¨' : 'é—œé–‰'));
        };
    }

    (function(){
        if (!timeInput) return;
        var syncBtn = document.createElement('button');
        syncBtn.id = 'pbs-sync';
        syncBtn.textContent = 'Sync';
        syncBtn.style.marginTop = '4px';
        syncBtn.style.padding = '4px 6px';
        syncBtn.style.fontSize = '11px';
        syncBtn.style.background = '#007bff';
        syncBtn.style.color = '#fff';
        syncBtn.style.border = 'none';
        syncBtn.style.borderRadius = '4px';
        syncBtn.style.cursor = 'pointer';
        timeInput.parentNode.appendChild(syncBtn);

        syncBtn.onclick = function () {
            log('INFO', 'é–‹å§‹å°éŒ¶...');
            var t0 = Date.now();
            fetch(window.location.href, { method: 'HEAD', cache: 'no-store' })
                .then(function (r) {
                    var t1 = Date.now();
                    var dateHeader = r.headers.get('date');
                    if (!dateHeader) {
                        log('WARNING', 'ä¼ºæœå™¨ç„¡ Date Headerï¼Œç”¨è¿”æœ¬åœ°æ™‚é–“');
                        serverOffset = 0;
                        return;
                    }
                    var serverTime = new Date(dateHeader).getTime();
                    var latency = (t1 - t0) / 2;
                    var adjustedServer = serverTime + latency;
                    serverOffset = adjustedServer - t1;
                    log('SUCCESS', 'å°éŒ¶å®Œæˆï¼ŒServer Offset: ' + serverOffset + 'ms');
                })
                .catch(function (e) {
                    log('ERROR', 'å°éŒ¶å¤±æ•—: ' + e);
                    serverOffset = 0;
                });
        };
    })();

    var pid = null;
    try {
        var scripts = [].slice.call(document.querySelectorAll('script'));
        for (var i = 0; i < scripts.length; i++) {
            if (scripts[i].textContent.includes('PRELOAD_DATA =')) {
                var jsonMatch = scripts[i].textContent.match(/PRELOAD_DATA\s*=\s*({.*?})\s*$/m);
                if (jsonMatch) {
                    var data = JSON.parse(jsonMatch[1]);
                    if(data.product && data.product.areaItemNos) {
                        pid = data.product.areaItemNos[0];
                        log('SUCCESS', 'è‡ªå‹•é–å®šå•†å“ ID: ' + pid);
                        status.innerHTML = 'Locked: ' + pid + ' <span style="color:#00bfff">ğŸ›¡ï¸Guardian ON</span>';
                        status.style.color = '#0f0';
                    }
                }
                break;
            }
        }
    } catch(e) {
        log('ERROR', 'è§£æ ID å¤±æ•—: ' + e.message);
    }

    if(!pid) log('WARNING', 'æœªæ‰¾åˆ°å•†å“ IDï¼Œè«‹ç¢ºèªåœ¨å•†å“è©³æƒ…é ');

    function startCountdown(targetTimeMs) {
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = setInterval(function(){
            var now = Date.now() + serverOffset;
            var diff = targetTimeMs - now;
            if (diff <= 0) {
                cdLabel.textContent = '0.00 s';
                clearInterval(countdownTimer);
                countdownTimer = null;
                return;
            }
            var s = (diff/1000).toFixed(2);
            cdLabel.textContent = s + ' s';
        }, 100);
    }

    function fireWithRetry(url, config, max5xxRetries, attempt5xx, suspendedRetriesLeft) {
        attempt5xx = attempt5xx || 1;
        if (suspendedRetriesLeft == null) suspendedRetriesLeft = 3;

        log('INFO', 'ç™¼é€è³¼è²·è«‹æ±‚... (Attempt ' + attempt5xx + '/' + max5xxRetries + ', SusLeft ' + suspendedRetriesLeft + ')');

        var sendTime = Date.now() + serverOffset;

        return fetch(url, config).then(function(r){
            var receiveTime = Date.now() + serverOffset;
            var latency = receiveTime - sendTime;
            
            log('INFO', 'Response: ' + r.status + ' (latency: ' + latency + 'ms)');

            return r.text().then(function(txt){
                var parsed = null;
                try { parsed = JSON.parse(txt); } catch(_) {}

                if(r.status >= 500 && !r.ok && attempt5xx < max5xxRetries){
                    log('WARNING', 'ä¼ºæœå™¨ 5xx ('+r.status+')ï¼Œæº–å‚™é‡è©¦...');
                    return new Promise(function(res){
                        setTimeout(res, 300);
                    }).then(function(){
                        return fireWithRetry(url, config, max5xxRetries, attempt5xx+1, suspendedRetriesLeft);
                    });
                }

                if(
                    suspendedRetryEnabled &&
                    r.status === 400 &&
                    parsed && parsed.error &&
                    parsed.error.indexOf('CouldNotAddToCartBySuspendedItem') !== -1 &&
                    suspendedRetriesLeft > 0
                ){
                    log('WARNING', 'å•†å“ç‹€æ…‹ Suspendedï¼Œå˜—è©¦å†è£œå°„ (å‰© ' + (suspendedRetriesLeft-1) + ' æ¬¡)...');
                    return new Promise(function(res){
                        setTimeout(res, 350);
                    }).then(function(){
                        return fireWithRetry(url, config, max5xxRetries, attempt5xx, suspendedRetriesLeft-1);
                    });
                }

                log(r.ok ? 'SUCCESS' : 'ERROR', 'HTTP Status: ' + r.status);
                return txt;
            });
        });
    }

    btn.onclick = function() {
        var timeStr   = timeInput.value;
        var qty       = parseInt(qtyInput.value)    || 1;
        var offset    = parseInt(offsetInput.value) || 0;
        var fetchCode = fetchInput.value;

        if (!pid)       { log('ERROR', 'ç„¡æ³•å•Ÿå‹•: ç¼ºå°‘å•†å“ ID'); return; }
        if (!fetchCode) { log('ERROR', 'ç„¡æ³•å•Ÿå‹•: è«‹è²¼ä¸Š Fetch ä»£ç¢¼'); return; }

        // --- ä¿®æ­£é‡é»ï¼šä½¿ç”¨é›™åæ–œç·š \\( ä¾†åŒ¹é…æ‹¬è™Ÿ ---
        var match = fetchCode.match(/fetch\((["'])(.*?)\1,\s*({[\s\S]*})\)/);
        
        // è¬ä¸€æ­£å‰‡é‚„æ˜¯å¤±æ•—ï¼Œæˆ‘å€‘å˜—è©¦åšæœ€å¾Œçš„å®¹éŒ¯ï¼šæ‰‹å‹•å°‹æ‰¾æ‹¬è™Ÿä½ç½®
        if (!match) {
            try {
                // æ‰‹å‹•è§£ææ³•ï¼šä¸ä¾è³´ Regex
                let startUrl = fetchCode.indexOf('fetch(');
                if(startUrl === -1) throw new Error('no fetch');
                let firstQuote = fetchCode.indexOf("'", startUrl);
                let doubleQuote = fetchCode.indexOf('"', startUrl);
                let quote = (firstQuote !== -1 && (doubleQuote === -1 || firstQuote < doubleQuote)) ? "'" : '"';
                
                let startUrlContent = fetchCode.indexOf(quote, startUrl) + 1;
                let endUrlContent = fetchCode.indexOf(quote, startUrlContent);
                let url = fetchCode.substring(startUrlContent, endUrlContent);
                
                let startObj = fetchCode.indexOf('{', endUrlContent);
                let endObj = fetchCode.lastIndexOf('}');
                let configStr = fetchCode.substring(startObj, endObj + 1);
                
                match = [null, quote, url, configStr]; // å½é€ ä¸€å€‹ match array
                log('INFO', 'Regexå¤±æ•—ï¼Œåˆ‡æ›è‡³æ‰‹å‹•è§£ææ¨¡å¼æˆåŠŸ');
            } catch(e) {
                log('ERROR', 'Fetch æ ¼å¼éŒ¯èª¤ (Regex & Manual failed)'); 
                return;
            }
        }

        var url = match[2];
        var configStr = match[3];
        var config;
        try { config = new Function('return ' + configStr)(); }
        catch(e) { log('ERROR', 'Fetch Config è§£æå¤±æ•—'); return; }

        config.body = JSON.stringify([{ areaItemNo: pid, qty: qty }]);
        config.credentials = 'include';

        var now = new Date(Date.now() + serverOffset);
        var target = new Date(now);
        var t = timeStr.split(':');
        target.setHours(t[0], t[1], t[2], 0);
        var delay = target.getTime() - now.getTime() + offset;

        lastPlannedFireTime = target.getTime() + offset;

        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.innerText = 'â³ å€’æ•¸ä¸­...';

        if(delay < 0) {
            log('WARNING', 'æ™‚é–“å·²éï¼Œç«‹å³ç™¼å°„! (Delay: ' + delay + 'ms)');
            delay = 0;
        } else {
            log('INFO', 'å°‡æ–¼ ' + (delay/1000).toFixed(3) + ' ç§’å¾Œç™¼å°„');
        }

        startCountdown(lastPlannedFireTime);

        setTimeout(function() {
            fireWithRetry(url, config, 5)
                .then(function(txt){
                    var parsed = null;
                    try { parsed = JSON.parse(txt); } catch(_) {}

                    if(parsed && parsed.totalCartCount){
                        log('SUCCESS', 'ğŸ‰ æˆåŠŸåŠ å…¥è³¼ç‰©è»Š (æ•¸é‡: ' + qty + ') | è³¼ç‰©è»Šç¸½æ•¸: ' + parsed.totalCartCount);
                    } else if(parsed && parsed.additional && parsed.additional.productOutOfStock){
                        log('WARNING', 'å•†å“å·²å”®ç½„ (productOutOfStock)');
                    } else if(parsed && parsed.error && parsed.error.indexOf('OutOfStock') !== -1){
                        log('WARNING', 'å•†å“å·²å”®ç½„ (OutOfStock)');
                    } else if(parsed && parsed.error && parsed.error.indexOf('SuspendedItem') !== -1){
                        log('WARNING', 'å•†å“ç‹€æ…‹ä»ç‚º Suspended');
                    } else if(txt){
                        log('WARNING', 'å›æ‡‰ç•°å¸¸: ' + txt.slice(0, 100));
                    } else {
                        log('WARNING', 'å›æ‡‰ç‚ºç©º');
                    }

                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.innerText = 'ğŸš€ Start';
                })
                .catch(function(e){
                    log('ERROR', 'æœ€çµ‚å¤±æ•—: ' + e);
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.innerText = 'ğŸš€ Start';
                });
        }, delay);
    };
})();
